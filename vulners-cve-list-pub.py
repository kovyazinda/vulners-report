import vulners
import sys
import getopt
import re
import json
import xlsxwriter

def main(argv):

 record_limit = 100

 try:
  opts, args = getopt.getopt(argv,"hi:o:")
 except getopt.GetoptError:
  print ('test.py -i queries.txt -o filename.xlsx')
  sys.exit(2)
 for opt, arg in opts:

  if opt == '-h':
   print ('test.py -i queries.txt -o filename.xlsx')
   sys.exit()
  elif opt in ("-i"):
   inputfile = arg
  elif opt in ("-o"):
   outputfile = arg



 print ('Inputfile:', inputfile)
 print ('Outputfile:', outputfile)
 print ('Recordlimit:', record_limit)

# reading file with queries
 inputFH = open(inputfile,"r")

 if outputfile:
# Writing to excel
  workbook = xlsxwriter.Workbook(outputfile)
  worksheet = workbook.add_worksheet()

#apply default row height
  worksheet.set_default_row(70)

#applying cell format
  cell_format_header = workbook.add_format({'bold': True, 'font_color': 'black'})
  cell_format_normal = workbook.add_format({'bold': False, 'font_color': 'black', 'text_wrap' : True})
  cell_format_bad = workbook.add_format({'bold': False, 'font_color': 'black', 'bg_color': 'red','text_wrap' : True})

# writing column headers

  worksheet.write (0,0,"Query",cell_format_header)
  worksheet.write (0,1,"URL",cell_format_header)
  worksheet.write (0,2,"Title",cell_format_header)
  worksheet.write (0,3,"Description",cell_format_header)
  worksheet.write (0,4,"Type",cell_format_header)
  worksheet.write (0,5,"CVSS",cell_format_header)  
  
# to start writing to next rown
  rownum=1


 
 for query in inputFH: 

# replace with your own vulners api key
  vulners_api = vulners.Vulners(api_key="123456")

# query is limited to CVE - remove the type:cve contstaint if you need full search
  if record_limit:
   product_search = vulners_api.search("type:cve "+query, limit=record_limit)
  else:
   product_search = vulners_api.search("type:cve "+query, limit=100)


# transforming and reading json
  search_string=json.dumps(product_search)

  search_json=json.loads(search_string)


  for vulnerabilities in search_json:
   try:
    valuearr=[query,vulnerabilities["vhref"],vulnerabilities["title"],vulnerabilities["description"],vulnerabilities["type"],str(vulnerabilities["cvss"]["score"])]

    colnum=0
    for colvalue in valuearr:
     worksheet.write (rownum,colnum,colvalue,cell_format_normal)  
     colnum=colnum+1  

# incrementing row
    rownum=rownum+1
   except:
    try:
     print (query,vulnerabilities["vhref"]+" "+vulnerabilities["title"]+" "+vulnerabilities["description"]+" "+vulnerabilities["type"]+" "+str(vulnerabilities["cvss"]["score"]))
    except:
     pass

# closing report files 
 workbook.close()

if __name__ == "__main__":
   main(sys.argv[1:])
